<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Snap2Pdf - Edit PDF</title>
<style>
body{font-family:Arial;background:#f5f7fb;margin:0}
.top{background:#fff;padding:10px;display:flex;gap:10px;align-items:center;box-shadow:0 1px 5px rgba(0,0,0,0.1)}
button{padding:8px 12px;border:0;border-radius:6px;background:#007bff;color:#fff;cursor:pointer}
#pages{max-width:1000px;margin:20px auto;display:flex;flex-direction:column;gap:20px}
.page{position:relative;background:#fff;border:1px solid #ccc}
.ocr{position:absolute;white-space:pre-wrap;padding:2px;border:1px dashed transparent}
.ocr:focus{outline:none;border-color:#007bff;background:#fff}
</style>
</head>
<body>
<div class="top">
  <a href="index.html">üè† Home</a>
  <input id="file" type="file" accept="application/pdf">
  <button id="upload">Upload</button>
  <button id="save">Save</button>
</div>
<div id="pages"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
const SERVER="https://snap2pdf-rf3r.onrender.com"; // 
let pdfDoc=null,tmpfile=null;
const pagesDiv=document.getElementById('pages');
document.getElementById('upload').onclick=async()=>{
  const f=document.getElementById('file').files[0];
  if(!f)return alert('Select PDF file');
  const fd=new FormData();fd.append('file',f);
  const r=await fetch(SERVER+'/upload',{method:'POST',body:fd});
  const j=await r.json();tmpfile=j.tmpfile;
  const buf=await f.arrayBuffer();pdfDoc=await pdfjsLib.getDocument({data:buf}).promise;
  pagesDiv.innerHTML='';
  for(let p=1;p<=pdfDoc.numPages;p++)await renderPage(p);
};
async function renderPage(num){
  const page=await pdfDoc.getPage(num),v=page.getViewport({scale:1.5});
  const div=document.createElement('div');div.className='page';div.dataset.page=num-1;
  const cnv=document.createElement('canvas');cnv.width=v.width;cnv.height=v.height;div.appendChild(cnv);
  await page.render({canvasContext:cnv.getContext('2d'),viewport:v}).promise;
  const layer=document.createElement('div');layer.style.position='absolute';layer.style.left='0';layer.style.top='0';layer.style.width=v.width+'px';layer.style.height=v.height+'px';
  const text=await page.getTextContent();
  text.items.forEach(it=>{
    const t=pdfjsLib.Util.transform(v.transform,it.transform);
    const x=t[4],y=t[5],fs=Math.abs(t[5]-t[3])/1.5;
    const d=document.createElement('div');d.className='ocr';d.contentEditable=true;d.textContent=it.str;
    d.style.left=x+'px';d.style.top=(y-fs)+'px';d.style.fontSize=fs+'px';layer.appendChild(d);
  });
  div.appendChild(layer);pagesDiv.appendChild(div);
}
document.getElementById('save').onclick=async()=>{
  if(!tmpfile)return alert('Upload first');
  const edits=[];
  document.querySelectorAll('.page').forEach(pg=>{
    const p=parseInt(pg.dataset.page);
    const layer=pg.children[1];
    const cnv=pg.children[0];
    const scaleX=cnv.width/layer.clientWidth,scaleY=cnv.height/layer.clientHeight;
    layer.querySelectorAll('.ocr').forEach(n=>{
      const r=n.getBoundingClientRect(),lr=layer.getBoundingClientRect();
      const x=(r.left-lr.left)*scaleX,y=(r.top-lr.top)*scaleY,w=r.width*scaleX,h=r.height*scaleY;
      edits.push({page:p,x,y,w,h,text:n.textContent,font:'helv',size:12,color:[0,0,0]});
    });
  });
  const res=await fetch(SERVER+'/apply_edits',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tmpfile,edits})});
  const blob=await res.blob();
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='edited.pdf';a.click();
};
</script>
</body>
</html>
