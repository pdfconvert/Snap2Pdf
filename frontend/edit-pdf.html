<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Snap2PDF Connected Editor</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root {
  --primary:#1565c0;
  --bg:#f4f6fb;
  --panel:#fff;
  --font:"Noto Sans","Noto Sans Devanagari",Arial,sans-serif;
}
body{margin:0;font-family:var(--font);background:var(--bg);display:flex;flex-direction:column;height:100vh}
.toolbar{background:var(--panel);box-shadow:0 2px 8px rgba(0,0,0,0.1);padding:8px 16px;display:flex;align-items:center;gap:10px;z-index:10}
.toolbar button,.toolbar select,.toolbar input[type=color]{border:none;padding:6px 10px;border-radius:6px}
.toolbar button{background:var(--primary);color:#fff;cursor:pointer}
.toolbar button:hover{background:#0d47a1}
#workspace{flex:1;overflow:auto;display:flex;justify-content:center;align-items:flex-start;padding:20px}
.page-frame{position:relative;background:#fff;box-shadow:0 3px 20px rgba(0,0,0,0.1);margin-bottom:40px}
canvas{display:block;width:100%}
#text-layer{position:absolute;inset:0;pointer-events:auto}
.editable{position:absolute;white-space:pre-wrap;cursor:text;color:#000;font-family:var(--font)}
.editable.active{outline:1px dashed var(--primary);background:rgba(21,101,192,0.05)}
.navbar{margin-left:auto;display:flex;align-items:center;gap:8px}
</style>
</head>
<body>

<div class="toolbar">
  <input type="file" id="file" accept="application/pdf">
  <label>Font:
    <select id="fontSel">
      <option value="'Noto Sans','Noto Sans Devanagari'">Noto Sans</option>
      <option value="Mangal,'Noto Sans Devanagari'">Mangal</option>
      <option value="Arial,sans-serif">Arial</option>
    </select>
  </label>
  <label>Size:
    <select id="sizeSel"><option>12</option><option selected>14</option><option>18</option><option>24</option></select>
  </label>
  <input type="color" id="colorSel" value="#000000">
  <button id="addText">Add Text</button>
  <button id="save">Save PDF</button>

  <div class="navbar">
    <button id="prev">◀ Prev</button>
    <span id="page-num">0 / 0</span>
    <button id="next">Next ▶</button>
  </div>
</div>

<div id="workspace">
  <div class="page-frame" id="pageFrame">
    <canvas id="pdfCanvas"></canvas>
    <div id="text-layer"></div>
  </div>
</div>

<script>
const SERVER = "https://snap2pdf-rf3r.onrender.com"; // ✅ backend link
const fileInput=document.getElementById("file");
const pdfCanvas=document.getElementById("pdfCanvas");
const textLayer=document.getElementById("text-layer");
const fontSel=document.getElementById("fontSel");
const sizeSel=document.getElementById("sizeSel");
const colorSel=document.getElementById("colorSel");
const addText=document.getElementById("addText");
const saveBtn=document.getElementById("save");
const prevBtn=document.getElementById("prev");
const nextBtn=document.getElementById("next");
const pageNum=document.getElementById("page-num");
let ctx=pdfCanvas.getContext("2d");
let pdfDoc=null,pageNumNow=1,totalPages=0,currentScale=1;

pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

fileInput.onchange=async e=>{
  const file=e.target.files[0];
  if(!file)return;
  const formData=new FormData();
  formData.append("file",file);
  const res=await fetch(`${SERVER}/upload`,{method:"POST",body:formData});
  const data=await res.json();
  if(!data || !data.tmpfile){alert("Upload failed");return;}
  const bytes=new Uint8Array(await file.arrayBuffer());
  pdfDoc=await pdfjsLib.getDocument({data:bytes}).promise;
  totalPages=pdfDoc.numPages;
  pageNumNow=1;
  renderPage(pageNumNow);
};

async function renderPage(num){
  const page=await pdfDoc.getPage(num);
  const vw=page.getViewport({scale:1});
  currentScale=800/vw.width;
  const viewport=page.getViewport({scale:currentScale});
  pdfCanvas.width=viewport.width;
  pdfCanvas.height=viewport.height;
  await page.render({canvasContext:ctx,viewport}).promise;
  textLayer.innerHTML="";
  pageNum.textContent=`${num} / ${totalPages}`;
}
prevBtn.onclick=()=>{if(pageNumNow>1){pageNumNow--;renderPage(pageNumNow);}};
nextBtn.onclick=()=>{if(pageNumNow<totalPages){pageNumNow++;renderPage(pageNumNow);}};

addText.onclick=()=>{
  const div=document.createElement("div");
  div.className="editable active";
  div.style.left="60px";
  div.style.top="60px";
  div.style.fontFamily=fontSel.value;
  div.style.fontSize=sizeSel.value+"px";
  div.style.color=colorSel.value;
  div.textContent="Type here...";
  div.contentEditable=true;
  textLayer.appendChild(div);
  dragEnable(div);
  div.focus();
  div.onclick=()=>{document.querySelectorAll(".editable").forEach(x=>x.classList.remove("active"));div.classList.add("active");};
};

function dragEnable(el){
  let isDown=false,offset=[0,0];
  el.addEventListener("mousedown",e=>{if(e.target.contentEditable!="true"){isDown=true;offset=[el.offsetLeft-e.clientX,el.offsetTop-e.clientY];}});
  document.addEventListener("mouseup",()=>isDown=false);
  document.addEventListener("mousemove",e=>{
    if(isDown){el.style.left=e.clientX+offset[0]+"px";el.style.top=e.clientY+offset[1]+"px";}
  });
}

saveBtn.onclick=()=>{
  const {jsPDF}=window.jspdf;
  const w=pdfCanvas.width,h=pdfCanvas.height;
  const out=document.createElement("canvas");out.width=w;out.height=h;
  const octx=out.getContext("2d");
  octx.fillStyle="#fff";octx.fillRect(0,0,w,h);
  octx.drawImage(pdfCanvas,0,0,w,h);
  textLayer.querySelectorAll(".editable").forEach(el=>{
    const left=parseFloat(el.style.left)||0;
    const top=parseFloat(el.style.top)||0;
    const fs=parseFloat(el.style.fontSize)||14;
    const color=el.style.color||"#000";
    const ff=el.style.fontFamily||fontSel.value;
    const text=el.textContent;
    const tmp=document.createElement("canvas").getContext("2d");
    tmp.font=`${fs}px ${ff}`;
    const wtxt=tmp.measureText(text).width;
    octx.fillStyle="#fff";octx.fillRect(left-2,top-2,wtxt+4,fs*1.3);
    octx.font=`${fs}px ${ff}`;
    octx.fillStyle=color;
    octx.fillText(text,left,top+fs);
  });
  const img=out.toDataURL("image/png");
  const pdf=new jsPDF({unit:"pt",format:[w,h]});
  pdf.addImage(img,"PNG",0,0,w,h);
  pdf.save("snap2pdf-edited.pdf");
};
</script>
</body>
</html>
