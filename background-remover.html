<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Background Remover | Snap2PDF</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    :root {
      --primary: #4361ee;
      --secondary: #3a0ca3;
      --accent: #4cc9f0;
      --dark: #212529;
      --light: #f8f9fa;
      --gray: #6c757d;
      --surface: #ffffff;
      --muted: #7a7f8c;
    }
    body { background: linear-gradient(180deg, #f3f4ff 0%, #f8f9ff 100%); color: var(--dark); min-height: 100vh; display: flex; flex-direction: column; line-height: 1.6; }
    .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 24px; }
    header { background: #fff; position: sticky; top: 0; z-index: 100; box-shadow: 0 10px 40px rgba(14, 32, 86, 0.08); }
    .navbar { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; }
    .logo { display: flex; gap: 10px; align-items: center; font-size: 22px; font-weight: 700; color: var(--primary); text-decoration: none; }
    .logo i { color: var(--secondary); }
    .nav-links { display: flex; gap: 22px; align-items: center; }
    .nav-links a { color: var(--dark); text-decoration: none; font-weight: 500; }
    .nav-links a:hover, .nav-links a.active { color: var(--primary); }
    .dropdown { position: relative; }
    .dropdown-content { display: none; position: absolute; background: #fff; min-width: 220px; border-radius: 12px; box-shadow: 0 16px 40px rgba(14, 32, 86, 0.12); top: 100%; left: 0; padding: 12px 0; }
    .dropdown:hover .dropdown-content { display: block; }
    .dropdown-content a { display: block; padding: 10px 20px; color: var(--dark); text-decoration: none; }
    .hero { background: radial-gradient(circle at top left, rgba(67, 97, 238, 0.2), transparent 60%), #ffffff; padding: 50px 0; text-align: center; margin-bottom: 30px; border-radius: 0 0 32px 32px; }
    .hero h1 { font-size: 2.8rem; margin-bottom: 12px; color: #111b46; }
    .hero p { color: var(--muted); font-size: 1.1rem; }
    .hero-badges { margin-top: 18px; display: inline-flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
    .hero-badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 999px; background: rgba(67,97,238,0.1); color: #2d3796; font-weight: 600; font-size: 0.9rem; }
    .workspace { max-width: 1200px; margin: 0 auto 40px; padding: 0 24px; display: grid; grid-template-columns: minmax(320px, 420px) 1fr; gap: 28px; align-items: start; }
    .panel { background: var(--surface); border-radius: 20px; padding: 24px; box-shadow: 0 24px 60px rgba(15, 30, 70, 0.08); }
    .panel h2 { font-size: 1.3rem; color: #15205b; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
    .upload-dropzone { border: 2px dashed rgba(67,97,238,0.4); border-radius: 18px; padding: 36px 24px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 14px; background: rgba(67, 97, 238, 0.05); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .upload-dropzone:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(67, 97, 238, 0.15); }
    .upload-dropzone.dragover { border-color: var(--secondary); background: rgba(58, 12, 163, 0.08); }
    .upload-dropzone i { font-size: 48px; color: var(--primary); }
    .upload-meta { font-size: 0.9rem; color: var(--muted); }
    .options { margin-top: 22px; display: flex; flex-direction: column; gap: 18px; }
    .option-group h3 { font-size: 1rem; color: #16205a; margin-bottom: 8px; }
    .background-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 12px; }
    .bg-swatch { border: 2px solid transparent; border-radius: 14px; padding: 14px; text-align: center; cursor: pointer; display: flex; flex-direction: column; gap: 8px; align-items: center; justify-content: center; background: linear-gradient(180deg, #f9f9ff, #eef1ff); font-weight: 600; color: #202753; transition: border-color 0.2s, transform 0.2s; }
    .bg-swatch span { font-size: 0.85rem; }
    .bg-swatch:hover { transform: translateY(-2px); }
    .bg-swatch.selected { border-color: var(--primary); box-shadow: 0 10px 20px rgba(67, 97, 238, 0.18); }
    .bg-swatch.trans { background: repeating-conic-gradient(#eff1ff 0deg 25deg, #ffffff 25deg 50deg); }
    .bg-swatch.custom { background: #ffffff; border: 2px dashed rgba(32, 39, 83, 0.25); }
    .custom-color-picker { display: flex; align-items: center; gap: 12px; }
    .custom-color-picker input[type="color"] { width: 42px; height: 42px; border: none; border-radius: 12px; padding: 0; cursor: pointer; background: none; }
    .custom-bg-upload { border: 2px dashed rgba(33, 47, 122, 0.25); border-radius: 14px; padding: 12px; display: flex; align-items: center; justify-content: space-between; gap: 12px; font-size: 0.9rem; color: var(--muted); }
    .custom-bg-upload button { background: var(--primary); color: #fff; border: none; border-radius: 999px; padding: 8px 18px; cursor: pointer; font-weight: 600; }
    .result-card { position: relative; overflow: hidden; }
    .result-preview { position: relative; border-radius: 18px; background: #f3f3f3; min-height: 380px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(18, 20, 58, 0.08); }
    .result-preview canvas, .result-preview img { max-width: 100%; max-height: 100%; border-radius: 16px; }
    .result-preview.empty { background: repeating-conic-gradient(#e5e9ff 0deg 25deg, #f8f9ff 25deg 50deg); color: var(--muted); font-size: 1rem; }
    .result-actions { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 12px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; border: none; border-radius: 999px; padding: 10px 22px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: transform 0.2s, box-shadow 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #4361ee, #3a0ca3); color: #fff; box-shadow: 0 14px 30px rgba(67, 97, 238, 0.25); }
    .btn-outline { background: #fff; border: 1px solid rgba(67, 97, 238, 0.2); color: #273474; }
    .btn[disabled] { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }
    .loader { display: none; align-items: center; gap: 10px; padding: 12px 16px; border-radius: 12px; background: rgba(67, 97, 238, 0.08); color: var(--primary); font-weight: 600; }
    .loader.active { display: inline-flex; }
    .loader span { width: 18px; height: 18px; border: 2px solid rgba(67, 97, 238, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .before-after { margin-top: 40px; background: var(--surface); border-radius: 18px; padding: 24px; box-shadow: 0 20px 50px rgba(15, 30, 70, 0.08); }
    .before-after h3 { margin-bottom: 16px; color: #17246d; }
    .before-after-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
    .before-after-card { position: relative; overflow: hidden; border-radius: 14px; box-shadow: 0 12px 24px rgba(16, 29, 71, 0.08); }
    .before-after-card img { width: 100%; display: block; }
    .before-after-card span { position: absolute; top: 12px; left: 12px; padding: 6px 12px; border-radius: 999px; background: rgba(0, 0, 0, 0.55); color: #fff; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.04em; }
    .comment-section { margin: 50px 0; }
    .comment-section h2 { margin-bottom: 16px; color: #1a2154; }
    .comment-form { display: grid; gap: 16px; background: var(--surface); border-radius: 16px; padding: 24px; box-shadow: 0 18px 40px rgba(17, 30, 72, 0.08); }
    .comment-form label { font-weight: 600; color: #2a326b; font-size: 0.95rem; }
    .comment-form input, .comment-form textarea { width: 100%; padding: 12px 14px; border: 1px solid rgba(67, 97, 238, 0.2); border-radius: 12px; font-size: 0.95rem; }
    .comment-form textarea { min-height: 120px; resize: vertical; }
    .comment-form button { justify-self: start; }
    footer { background: #0d1530; color: #e8ecff; padding: 50px 0 30px; margin-top: auto; }
    .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 30px; margin-bottom: 30px; }
    .footer-grid h3 { margin-bottom: 12px; font-size: 1rem; }
    .footer-links { list-style: none; display: flex; flex-direction: column; gap: 8px; }
    .footer-links a { color: rgba(232, 236, 255, 0.75); text-decoration: none; font-size: 0.95rem; }
    .footer-links a:hover { color: #fff; }
    .copyright { text-align: center; border-top: 1px solid rgba(232, 236, 255, 0.16); padding-top: 20px; font-size: 0.85rem; color: rgba(232,236,255,0.6); }
    @media (max-width: 1024px) {
      .workspace { grid-template-columns: 1fr; }
      .result-preview { min-height: 320px; }
    }
    @media (max-width: 768px) {
      .nav-links { display: none; }
      header { position: relative; }
      .hero { padding: 40px 0; }
      .hero h1 { font-size: 2.2rem; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <nav class="navbar">
        <a href="index.html" class="logo"><i class="fas fa-file-pdf"></i><span>Snap2PDF</span></a>
        <div class="nav-links">
          <a href="index.html" class="active">Home</a>
          <div class="dropdown">
            <a href="#">Convert to PDF <i class="fas fa-chevron-down"></i></a>
            <div class="dropdown-content">
              <a href="jpg-to-pdf.html">JPG to PDF</a>
              <a href="word-to-pdf.html">Word to PDF</a>
              <a href="excel-to-pdf.html">Excel to PDF</a>
              <a href="ppt-to-pdf.html">PowerPoint to PDF</a>
            </div>
          </div>
          <div class="dropdown">
            <a href="#">Convert from PDF <i class="fas fa-chevron-down"></i></a>
            <div class="dropdown-content">
              <a href="pdf-to-jpg.html">PDF to JPG</a>
              <a href="pdf-to-word.html">PDF to Word</a>
              <a href="pdf-to-excel.html">PDF to Excel</a>
              <a href="pdf-to-ppt.html">PDF to PowerPoint</a>
            </div>
          </div>
          <div class="dropdown">
            <a href="#">Edit PDF <i class="fas fa-chevron-down"></i></a>
            <div class="dropdown-content">
              <a href="merge-pdf.html">Merge PDF</a>
              <a href="split-pdf.html">Split PDF</a>
              <a href="compress-pdf.html">Compress PDF</a>
              <a href="edit-pdf.html">Edit PDF</a>
              <a href="protect-pdf.html">Protect PDF</a>
              <a href="unlock-pdf.html">Unlock PDF</a>
              <a href="watermark-pdf.html">Watermark PDF</a>
              <a href="crop-pdf.html">Crop PDF</a>
            </div>
          </div>
          <div class="dropdown">
            <a href="#">Image Tools <i class="fas fa-chevron-down"></i></a>
            <div class="dropdown-content">
              <a href="image-compressor.html">Image Compressor</a>
              <a href="image-resizer.html">Image Resizer</a>
              <a href="image-editor.html">Image Editor</a>
              <a href="background-remover.html">Background Remover</a>
              <a href="ocr-image.html">OCR Image</a>
              <a href="image-watermark.html">Image Watermark Tool</a>
            </div>
          </div>
          <div class="dropdown">
            <a href="#">Design Tools <i class="fas fa-chevron-down"></i></a>
            <div class="dropdown-content">
              <a href="resume-maker.html">Resume Maker</a>
              <a href="biodata-maker.html">Biodata Maker</a>
              <a href="ai-image-generator.html">AI Image Generator</a>
              <a href="marriage-card.html">Marriage Card</a>
            </div>
          </div>
        </div>
        <div class="auth-buttons" style="display:flex;gap:10px;align-items:center;">
          <a href="#" class="btn-outline btn" onclick="showModal && showModal('login-modal');return false;">Login</a>
          <a href="#" class="btn btn-primary" onclick="showModal && showModal('signup-modal');return false;">Sign Up</a>
        </div>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="container">
      <h1>AI Background Remover</h1>
      <p>Remove photo backgrounds instantly, swap in solid colours, or drop in your own scene just like remove.bg.</p>
      <div class="hero-badges">
        <span class="hero-badge"><i class="fas fa-robot"></i> AI Powered</span>
        <span class="hero-badge"><i class="fas fa-cloud-upload-alt"></i> Works in Browser</span>
        <span class="hero-badge"><i class="fas fa-shield-alt"></i> Privacy Friendly</span>
      </div>
    </div>
  </section>

  <main class="workspace">
    <section class="panel" id="uploadPanel">
      <h2><i class="fas fa-image"></i> Upload & Options</h2>
      <div id="dropzone" class="upload-dropzone">
        <i class="fas fa-cloud-upload-alt"></i>
        <div>
          <strong>Drag & drop your JPG/PNG</strong>
        </div>
        <div class="upload-meta">Max 10MB • Transparent PNG recommended for best results</div>
        <button class="btn btn-primary" type="button" id="browseBtn">Choose Image</button>
        <input type="file" id="imageInput" accept="image/png,image/jpeg" hidden>
      </div>

      <div class="options">
        <div class="option-group">
          <h3>Background style</h3>
          <div class="background-options" id="bgOptions">
            <div class="bg-swatch trans selected" data-type="transparent">
              <i class="fas fa-border-none"></i>
              <span>Transparent</span>
            </div>
            <div class="bg-swatch" data-type="color" data-color="#ffffff" style="background:#ffffff;">
              <i class="fas fa-fill-drip" style="color:#5465ff"></i>
              <span>Pure White</span>
            </div>
            <div class="bg-swatch" data-type="color" data-color="#111827" style="background:#111827;color:#fff;">
              <i class="fas fa-fill-drip"></i>
              <span>Classic Dark</span>
            </div>
            <div class="bg-swatch" data-type="color" data-color="#fde047" style="background:#fde047;">
              <i class="fas fa-fill-drip" style="color:#734500"></i>
              <span>Sun Yellow</span>
            </div>
            <div class="bg-swatch" data-type="color" data-color="#bbf7d0" style="background:#bbf7d0;">
              <i class="fas fa-fill-drip" style="color:#065f46"></i>
              <span>Mint Green</span>
            </div>
            <div class="bg-swatch custom" data-type="custom-color">
              <i class="fas fa-palette" style="color:#7c3aed;"></i>
              <span>Pick Colour</span>
            </div>
            <div class="bg-swatch custom" data-type="custom-image">
              <i class="fas fa-image" style="color:#ee6c4d;"></i>
              <span>Upload BG</span>
            </div>
          </div>
          <div class="custom-color-picker" id="customColorPicker" style="display:none;">
            <input type="color" id="colorPicker" value="#4361ee">
            <label for="colorPicker" style="font-size:0.9rem;color:var(--muted);">Choose any colour</label>
          </div>
          <div class="custom-bg-upload" id="customBgUpload" style="display:none;">
            <span id="customBgLabel">Upload your background image</span>
            <button type="button" id="customBgBtn">Browse</button>
            <input type="file" id="customBgInput" accept="image/*" hidden>
          </div>
        </div>

        <div class="option-group">
          <h3>Smart Refinements</h3>
          <label style="display:flex;align-items:center;gap:10px;font-size:0.92rem;color:var(--muted);">
            <input type="checkbox" id="smoothEdges" checked>
            Smooth edges
          </label>
          <label style="display:flex;align-items:center;gap:10px;font-size:0.92rem;color:var(--muted);">
            <input type="checkbox" id="featherEdges" checked>
            Feather background mask slightly
          </label>
        </div>

        <div class="option-group">
          <div class="loader" id="loader"><span></span> Processing image…</div>
          <button class="btn btn-primary" type="button" id="removeBtn" disabled><i class="fas fa-magic"></i> Remove Background</button>
        </div>
      </div>
    </section>

    <section class="panel result-card" id="resultPanel">
      <h2><i class="fas fa-layer-group"></i> Preview & Export</h2>
      <div class="result-preview empty" id="resultPreview">
        <div>
          <i class="fas fa-image" style="font-size:42px;margin-bottom:12px;opacity:0.7;"></i>
          <p>Upload an image to see the magic ✨</p>
        </div>
      </div>
      <div class="result-actions">
        <button class="btn btn-primary" id="downloadPng" disabled><i class="fas fa-download"></i> Download PNG</button>
        <button class="btn btn-outline" id="downloadJpg" disabled><i class="fas fa-file-image"></i> Download JPG</button>
        <button class="btn btn-outline" id="resetBtn" disabled><i class="fas fa-undo"></i> Reset</button>
      </div>
    </section>
  </main>

  <section class="before-after container">
    <h3>Before & After • remove.bg style results</h3>
    <div class="before-after-gallery">
      <div class="before-after-card">
        <img src="https://images.unsplash.com/photo-1542291026-7eec264c27ff?auto=format&fit=crop&w=600&q=80" alt="Sample person">
        <span>Before</span>
      </div>
      <div class="before-after-card">
        <img src="https://images.unsplash.com/photo-1542291026-7eec264c27ff?auto=format&fit=crop&w=600&q=80&sat=-100&bg=transparent" alt="Sample after" style="background: repeating-conic-gradient(#e5e9ff 0deg 25deg,#f8f9ff 25deg 50deg);">
        <span>After</span>
      </div>
      <div class="before-after-card">
        <img src="https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=600&q=80" alt="Sample product">
        <span>Before</span>
      </div>
      <div class="before-after-card">
        <img src="https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=600&q=80&sat=-100&bg=ffffff" alt="Sample product after" style="background:#ffffff;">
        <span>After</span>
      </div>
    </div>
  </section>

  <section class="container comment-section">
    <h2>Share your experience</h2>
    <form class="comment-form">
      <div>
        <label for="commentName">Your Name</label>
        <input type="text" id="commentName" placeholder="Enter your name">
      </div>
      <div>
        <label for="commentEmail">Email</label>
        <input type="email" id="commentEmail" placeholder="Enter your email">
      </div>
      <div>
        <label for="commentMessage">Comment</label>
        <textarea id="commentMessage" placeholder="Share your feedback about the background remover"></textarea>
      </div>
      <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Submit Comment</button>
    </form>
  </section>

  <footer>
    <div class="container">
      <div class="footer-grid">
        <div>
          <h3>Snap2PDF</h3>
          <p>All-in-one workspace for document conversion, image editing, and design utilities.</p>
        </div>
        <div>
          <h3>Convert to PDF</h3>
          <ul class="footer-links">
            <li><a href="jpg-to-pdf.html">JPG to PDF</a></li>
            <li><a href="word-to-pdf.html">Word to PDF</a></li>
            <li><a href="excel-to-pdf.html">Excel to PDF</a></li>
            <li><a href="ppt-to-pdf.html">PowerPoint to PDF</a></li>
          </ul>
        </div>
        <div>
          <h3>Convert from PDF</h3>
          <ul class="footer-links">
            <li><a href="pdf-to-jpg.html">PDF to JPG</a></li>
            <li><a href="pdf-to-word.html">PDF to Word</a></li>
            <li><a href="pdf-to-excel.html">PDF to Excel</a></li>
            <li><a href="pdf-to-ppt.html">PDF to PowerPoint</a></li>
          </ul>
        </div>
        <div>
          <h3>Edit PDF</h3>
          <ul class="footer-links">
            <li><a href="merge-pdf.html">Merge PDF</a></li>
            <li><a href="split-pdf.html">Split PDF</a></li>
            <li><a href="compress-pdf.html">Compress PDF</a></li>
            <li><a href="edit-pdf.html">Edit PDF</a></li>
            <li><a href="protect-pdf.html">Protect PDF</a></li>
            <li><a href="unlock-pdf.html">Unlock PDF</a></li>
            <li><a href="watermark-pdf.html">Watermark PDF</a></li>
            <li><a href="crop-pdf.html">Crop PDF</a></li>
          </ul>
        </div>
        <div>
          <h3>Design Tools</h3>
          <ul class="footer-links">
            <li><a href="resume-maker.html">Resume Maker</a></li>
            <li><a href="biodata-maker.html">Biodata Maker</a></li>
            <li><a href="ai-image-generator.html">AI Image Generator</a></li>
            <li><a href="marriage-card.html">Marriage Card</a></li>
          </ul>
        </div>
        <div>
          <h3>Connect</h3>
          <ul class="footer-links">
            <li><a href="#"><i class="fab fa-facebook"></i> Facebook</a></li>
            <li><a href="#"><i class="fab fa-twitter"></i> Twitter</a></li>
            <li><a href="#"><i class="fab fa-instagram"></i> Instagram</a></li>
            <li><a href="#"><i class="fab fa-linkedin"></i> LinkedIn</a></li>
          </ul>
        </div>
      </div>
      <div class="copyright">
        &copy; <span id="footerYear"></span> Snap2PDF. All rights reserved. Icons by Font Awesome.
      </div>
    </div>
  </footer>

  <script type="module">
    const imageInput = document.getElementById('imageInput');
    const dropzone = document.getElementById('dropzone');
    const browseBtn = document.getElementById('browseBtn');
    const removeBtn = document.getElementById('removeBtn');
    const loader = document.getElementById('loader');
    const resultPreview = document.getElementById('resultPreview');
    const downloadPng = document.getElementById('downloadPng');
    const downloadJpg = document.getElementById('downloadJpg');
    const resetBtn = document.getElementById('resetBtn');
    const bgOptions = document.getElementById('bgOptions');
    const customColorPicker = document.getElementById('customColorPicker');
    const colorPicker = document.getElementById('colorPicker');
    const customBgUpload = document.getElementById('customBgUpload');
    const customBgBtn = document.getElementById('customBgBtn');
    const customBgInput = document.getElementById('customBgInput');
    const customBgLabel = document.getElementById('customBgLabel');
    const smoothEdges = document.getElementById('smoothEdges');
    const featherEdges = document.getElementById('featherEdges');

    let originalImage = null;
    let resultCanvas = null;
    let resultContext = null;
    let foregroundImageDataUrl = null;
    let currentBgType = 'transparent';
    let customBgImage = null;

    let removeBackgroundFn = null;
    try {
      ({ removeBackground: removeBackgroundFn } = await import('https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.7.0/dist/index.mjs'));
    } catch (err) {
      console.warn('Background removal library failed to load. Please check your internet connection.', err);
    }

    function showLoader(show) {
      loader.classList.toggle('active', show);
      removeBtn.disabled = show;
    }

    function resetUI() {
      originalImage = null;
      foregroundImageDataUrl = null;
      resultCanvas = null;
      customBgImage = null;
      currentBgType = 'transparent';
      Array.from(bgOptions.children).forEach((item) => item.classList.toggle('selected', item.dataset.type === 'transparent'));
      customColorPicker.style.display = 'none';
      customBgUpload.style.display = 'none';
      customBgLabel.textContent = 'Upload your background image';
      resultPreview.innerHTML = '<div><i class="fas fa-image" style="font-size:42px;margin-bottom:12px;opacity:0.7;"></i><p>Upload an image to see the magic ✨</p></div>';
      resultPreview.classList.add('empty');
      downloadPng.disabled = true;
      downloadJpg.disabled = true;
      resetBtn.disabled = true;
      removeBtn.disabled = true;
    }

    function updatePreview(canvas) {
      resultPreview.innerHTML = '';
      resultPreview.classList.remove('empty');
      resultPreview.appendChild(canvas);
      downloadPng.disabled = false;
      downloadJpg.disabled = false;
      resetBtn.disabled = false;
    }

    function buildCanvas(width, height) {
      resultCanvas = document.createElement('canvas');
      resultCanvas.width = width;
      resultCanvas.height = height;
      resultContext = resultCanvas.getContext('2d');
      return resultCanvas;
    }

    async function applyBackground() {
      if (!foregroundImageDataUrl || !resultCanvas || !resultContext) return;
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.src = foregroundImageDataUrl;
      await img.decode();

      // Draw base background
      if (currentBgType === 'transparent') {
        resultContext.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
      } else if (currentBgType === 'color') {
        resultContext.fillStyle = colorPicker.value;
        resultContext.fillRect(0, 0, resultCanvas.width, resultCanvas.height);
      } else if (currentBgType === 'preset-color') {
        const preset = applyBackground.lastPreset ?? '#ffffff';
        resultContext.fillStyle = preset;
        resultContext.fillRect(0, 0, resultCanvas.width, resultCanvas.height);
      } else if (currentBgType === 'custom-image' && customBgImage) {
        resultContext.drawImage(customBgImage, 0, 0, resultCanvas.width, resultCanvas.height);
      }

      // Draw foreground
      resultContext.drawImage(img, 0, 0, resultCanvas.width, resultCanvas.height);
    }

    async function processImage(file) {
      if (!file || !removeBackgroundFn) {
        alert('Background removal engine not available. Please check your internet connection.');
        return;
      }
      showLoader(true);
      try {
        const arrayBuffer = await file.arrayBuffer();
        const blob = new Blob([arrayBuffer]);
        const result = await removeBackgroundFn(blob, {
          debug: false,
          smoothEdges: smoothEdges.checked,
          featherRadius: featherEdges.checked ? 2 : 0
        });
        const resultBlob = await result.blob();
        foregroundImageDataUrl = URL.createObjectURL(resultBlob);

        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.src = foregroundImageDataUrl;
        await img.decode();

        buildCanvas(img.width, img.height);
        await applyBackground();
        updatePreview(resultCanvas);
      } catch (error) {
        console.error('Background removal failed', error);
        alert('Failed to remove background. Please try with a different image.');
      } finally {
        showLoader(false);
      }
    }

    function handleFileSelection(file) {
      if (!file) return;
      if (file.size > 10 * 1024 * 1024) {
        alert('Please upload an image smaller than 10MB.');
        return;
      }
      originalImage = file;
      removeBtn.disabled = false;
    }

    browseBtn.addEventListener('click', () => imageInput.click());
    imageInput.addEventListener('change', (e) => handleFileSelection(e.target.files[0]));

    dropzone.addEventListener('click', () => imageInput.click());
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        imageInput.files = e.dataTransfer.files;
        handleFileSelection(e.dataTransfer.files[0]);
      }
    });

    removeBtn.addEventListener('click', () => {
      if (originalImage) {
        processImage(originalImage);
      }
    });

    bgOptions.addEventListener('click', (e) => {
      const target = e.target.closest('.bg-swatch');
      if (!target) return;
      Array.from(bgOptions.children).forEach((item) => item.classList.remove('selected'));
      target.classList.add('selected');
      customColorPicker.style.display = 'none';
      customBgUpload.style.display = 'none';

      const type = target.dataset.type;
      if (type === 'custom-color') {
        currentBgType = 'color';
        customColorPicker.style.display = 'flex';
      } else if (type === 'custom-image') {
        currentBgType = 'custom-image';
        customBgUpload.style.display = 'flex';
      } else if (type === 'color') {
        currentBgType = 'preset-color';
        applyBackground.lastPreset = target.dataset.color;
        colorPicker.value = target.dataset.color;
      } else {
        currentBgType = type;
      }

      if (foregroundImageDataUrl && resultCanvas) {
        applyBackground();
      }
    });

    colorPicker.addEventListener('input', () => {
      if (currentBgType === 'color') {
        applyBackground();
      }
    });

    customBgBtn.addEventListener('click', () => customBgInput.click());
    customBgInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      customBgLabel.textContent = file.name;
      customBgImage = new Image();
      customBgImage.src = URL.createObjectURL(file);
      await customBgImage.decode();
      if (foregroundImageDataUrl && resultCanvas) {
        applyBackground();
      }
    });

    downloadPng.addEventListener('click', () => {
      if (!resultCanvas) return;
      const link = document.createElement('a');
      link.href = resultCanvas.toDataURL('image/png');
      link.download = 'background-removed.png';
      link.click();
    });

    downloadJpg.addEventListener('click', () => {
      if (!resultCanvas) return;
      const link = document.createElement('a');
      link.href = resultCanvas.toDataURL('image/jpeg', 0.95);
      link.download = 'background-removed.jpg';
      link.click();
    });

    resetBtn.addEventListener('click', () => {
      resetUI();
      imageInput.value = '';
      customBgInput.value = '';
    });

    document.querySelector('.comment-form').addEventListener('submit', (e) => {
      e.preventDefault();
      alert('Thanks for sharing your feedback!');
      e.target.reset();
    });

    document.getElementById('footerYear').textContent = new Date().getFullYear();
    resetUI();
  </script>
</body>
</html>
